@model Insights.Models.DateClassModel
@{
    ViewBag.Title = "IncentiveConfirmation";
    Layout = "~/Views/Shared/_Layout.cshtml";
    int month = Convert.ToInt16(ViewBag.month);
    int year = Convert.ToInt16(ViewBag.year);
}

<style>

    .hidden{
        display:none;
    }

    table.dataTable tbody tr.selected>* {
    box-shadow: inset 0 0 0 9999px rgb(13 110 253 / 90%);
    color: white;
    }

    table.dataTable tbody td.select-checkbox:before, table.dataTable tbody th.select-checkbox:before {
    content: " ";
    margin-top: -6px;
    margin-left: -6px;
    border: 1px solid black;
    border-radius: 3px;
}

table.dataTable tbody td.select-checkbox:before, table.dataTable tbody td.select-checkbox:after, table.dataTable tbody th.select-checkbox:before, table.dataTable tbody th.select-checkbox:after {
    display: block;
    position: absolute;
    top: 1.2em;
    left: 50%;
    width: 12px;
    height: 12px;
    box-sizing: border-box;
}

table.dataTable tr.selected td.select-checkbox:before, table.dataTable tr.selected th.select-checkbox:before {
    border: 1px solid white;
}
table.dataTable tbody td.select-checkbox:before, table.dataTable tbody th.select-checkbox:before {
    content: " ";
    margin-top: -6px;
    margin-left: -6px;
    border: 1px solid black;
    border-radius: 3px;
}
table.dataTable tbody td.select-checkbox:before, table.dataTable tbody td.select-checkbox:after, table.dataTable tbody th.select-checkbox:before, table.dataTable tbody th.select-checkbox:after {
    display: block;
    position: absolute;
    top: 1.2em;
    left: 50%;
    width: 12px;
    height: 12px;
    box-sizing: border-box;
}

table.dataTable tr.selected td.select-checkbox:after, table.dataTable tr.selected th.select-checkbox:after {
    content: "✓";
    font-size: 20px;
    margin-top: -19px;
    margin-left: -6px;
    text-align: center;
    text-shadow: 1px 1px #b0bed9, -1px -1px #b0bed9, 1px -1px #b0bed9, -1px 1px #b0bed9;
}
table.dataTable tbody td.select-checkbox:before, table.dataTable tbody td.select-checkbox:after, table.dataTable tbody th.select-checkbox:before, table.dataTable tbody th.select-checkbox:after {
    display: block;
    position: absolute;
    top: 1.2em;
    left: 50%;
    width: 12px;
    height: 12px;
    box-sizing: border-box;
}

.dataTables_wrapper .dataTables_scroll div.dataTables_scrollBody>table>thead>tr>th, .dataTables_wrapper .dataTables_scroll div.dataTables_scrollBody>table>thead>tr>td, .dataTables_wrapper .dataTables_scroll div.dataTables_scrollBody>table>tbody>tr>th, .dataTables_wrapper .dataTables_scroll div.dataTables_scrollBody>table>tbody>tr>td {
    vertical-align: middle;
}

table.dataTable tbody td.select-checkbox, table.dataTable tbody th.select-checkbox {
    position: relative;
}

    div.dataTables_wrapper div.dataTables_filter label {
        position: static;
    }

    .form-control, .asColorPicker-input, .dataTables_wrapper select, .jsgrid .jsgrid-table .jsgrid-filter-row input[type=text], .jsgrid .jsgrid-table .jsgrid-filter-row select, .jsgrid .jsgrid-table .jsgrid-filter-row input[type=number], .select2-container--default .select2-selection--single, .select2-container--default .select2-selection--single .select2-search__field, .typeahead, .tt-query, .tt-hint {
    border: 1px solid #CED4DA;
    font-weight: 400;
    font-size: 0.875rem;
    border-radius: 4px;
}
.form-control, .asColorPicker-input, .dataTables_wrapper select, .jsgrid .jsgrid-table .jsgrid-filter-row input[type=text], .jsgrid .jsgrid-table .jsgrid-filter-row select, .jsgrid .jsgrid-table .jsgrid-filter-row input[type=number], .select2-container--default .select2-selection--single, .select2-container--default .select2-selection--single .select2-search__field, .typeahead, .tt-query, .tt-hint, .form-control:focus, .asColorPicker-input:focus, .dataTables_wrapper select:focus, .jsgrid .jsgrid-table .jsgrid-filter-row input:focus[type=text], .jsgrid .jsgrid-table .jsgrid-filter-row select:focus, .jsgrid .jsgrid-table .jsgrid-filter-row input:focus[type=number], .select2-container--default .select2-selection--single:focus, .select2-container--default .select2-selection--single .select2-search__field:focus, .typeahead:focus, .tt-query:focus, .tt-hint:focus {
    -webkit-box-shadow: none;
    -moz-box-shadow: none;
    box-shadow: none;
    outline: 0;
}
.form-control-sm {
    height: 2.575rem;
    padding: 0.5rem 0.81rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem;
}
.form-control, .asColorPicker-input, .dataTables_wrapper select, .jsgrid .jsgrid-table .jsgrid-filter-row input[type=text], .jsgrid .jsgrid-table .jsgrid-filter-row select, .jsgrid .jsgrid-table .jsgrid-filter-row input[type=number], .select2-container--default .select2-selection--single, .select2-container--default .select2-selection--single .select2-search__field, .typeahead, .tt-query, .tt-hint {
    display: block;
    width: 100%;
    height: 2.875rem;
    padding: 0.875rem 1.375rem;
    font-size: 0.875rem;
    font-weight: 400;
    line-height: 1;
    color: #495057;
    background-color: #ffffff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: 2px;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

    .dataTables_wrapper .dataTable thead .sorting:after{
    top:10px !important;
    }
    .dataTables_wrapper .dataTable thead .sorting_asc:after{
        top:10px !important;
    }
    .dataTables_wrapper .dataTable thead .sorting_desc:after{
        top:10px !important;
    }


</style>

<div class="abc">
    <h2 style="margin-bottom:30px; display:flex; justify-content:space-between" id="statusName">Incentive - Verification Report 
    <span class="refreshicon"><i class="fa fa-refresh " aria-hidden="true" onclick="refreshPage();" style="font-size: 20px; cursor: pointer"></i> </span></h2>
        

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    @*<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.4.0/css/select.dataTables.min.css" />*@
    
    
    @*<link type="text/css" href="//gyrocode.github.io/jquery-datatables-checkboxes/1.2.12/css/dataTables.checkboxes.css" rel="stylesheet" />*@


    <div class="col-md-12">
        <div class="row">
            @using (Html.BeginForm("IncentiveVerification", "Home", FormMethod.Post, new { @class = "col-md-9", style = "display:contents;", name = "frm", id = "frm", onsubmit = "loadergif(1);" }))
            {
                <div class="col-md-3">
                    <div class="md-form mb-5">
                        <label>Month</label>
                        <select name="month" class="form-control validate js-example-basic-single" id="month">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10" >October</option>
                            <option value="11" >November</option>
                            <option value="12" >December</option>
                        </select>
                    </div>
                </div>
                    <div class="col-md-3">
                        
                            <label>Year</label>
                        <select name="year" class="form-control validate js-example-basic-single" id="year">
                            @*<option value="2023">2023</option>*@
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            @*<option value="2021">2021</option>
                            <option value="2020">2020</option>*@
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label><br /></label>
                        <div class="md-form mb-5">
                            <button type="submit" class="btn btn-primary" title="Generate Report"><i class="fa fa-cogs" style="margin-right: 5px;" aria-hidden="true"></i> Generate Report </button>
                        </div>
                    </div>

            }
        </div>
    </div>
    <div class="col-md-12" style="display:flex; flex-direction:row-reverse;">
        <div>
            <button type="button" class="btn btn-success saved hidden" id="btnSelectedRows">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
                    <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v7.293l2.646-2.647a.5.5 0 0 1 .708.708l-3.5 3.5a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L7.5 9.293V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"></path>
                </svg>
                @*<i class="fas fa-save"></i>*@
           &nbsp; Save</button>
        </div>
    </div>
    <div class="col-sm-12 hidden" id="hiddenTable_incentive_verification" style="top:20px;">
        <table id="IncentiveVerification" class="table dataTable no-footer" style="width:100%">
            @*<table id="IncentiveVerification" class=" dataTables_wrapper dt-bootstrap4 no-footer" style="width:100%">*@

            <thead>
                <tr>
                    <th></th>
                    <th class="hidden">EMP ID</th>
                    <th>NAME</th>
                    <th>TOTAL ORDERS</th>
                    <th>INCENTIVE ORDERS</th>
                    <th>INCENTIVE AMOUNT</th>
                    @*<th class="hidden">MONTH</th>
                        <th class="hidden">YEAR</th>*@
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>



<script type="text/JavaScript" src="https://MomentJS.com/downloads/moment-with-locales.js"></script>

<script src="https://cdn.datatables.net/buttons/1.2.2/js/dataTables.buttons.min.js" defer></script>
<script src="https://cdn.datatables.net/buttons/1.2.2/js/buttons.flash.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js" defer></script>
<script src="https://cdn.datatables.net/buttons/1.2.2/js/buttons.html5.min.js" defer></script>
<script src="https://cdn.datatables.net/buttons/1.2.2/js/buttons.print.min.js" defer></script>
<script src="https://www.bootstrapdash.com/demo/skydash/template/vendors/select2/select2.min.js"></script>
<script src="https://www.bootstrapdash.com/demo/skydash/template/js/select2.js"></script>
<script src="https://cdn.datatables.net/select/1.4.0/js/dataTables.select.min.js" defer></script>





<script>
    $(document).ready(function () {

        var previousMonth = (new Date().getMonth());

        //if(previousMonth==0)
        //    previousMonth=12

        var previousYear = (new Date().getFullYear())-1;

        const monthnames = ["January", "February", "March", "April", "May", "June",
                                "July", "August", "September", "October", "November", "December"];

        //const years = ["2020", "2021", "2022", "2023", "2024"];

        var monthName = monthnames[@month-1]

        var month = previousMonth;

        var option = "";
        var option1 = "";



        //var j = 1;
        //for(var i=0; i<month; i++){
        //    option+= '<option value="'+ j +'">' + monthnames[i] + "</option>"
        //    j++;
        //}
        //document.getElementById("month").innerHTML = option;

        //for(var i=202; i<3; i++){
        //    option1+= '<option value="'+ i+1 +'">' + years[i] + "</option>"

        //}
        //document.getElementById("year").innerHTML = option1;


        //$('input[type=search]').addClass('form-control form-control-sm');
        //$('#IncentiveVerification').dataTable();
        //$('#IncentiveVerification_filter').addClass('form-control form-control-sm');


        $.extend( $.fn.dataTableExt.oStdClasses, {
            "sFilterInput": "form-control",
            "sLengthSelect": "form-control"
        });


        if(@month!=null){
            //$('#month').val(@month)

            $("#select2-month-container").html(monthName);

            $("#month").val(@month).change();
        }
        if(@year!=null){
            if(previousMonth==0){
                $('#year').val(previousYear)
                $("#select2-year-container").html(previousYear);
            }else{
                $('#year').val(@year)
                $("#select2-year-container").html(@year);

                //$('#year').text(@year)
            }

        }

        //$('#month').find('option:contains("September")').hide();
        // $("#month option[value="+title"]").hide();
        main();

    });

    var tables;
    function main() {

        loadergif(1);
        var  Result = @Html.Raw(Json.Encode(ViewBag.VerifyData));

        Data = Result.Data;

        Datas = jQuery.parseJSON(Data);

        //if(Datas[0].resultMsg == "current data"){
        //    swal({
        //        title: 'Error!',
        //        text: 'Current month data is yet to be generated.',
        //        icon: 'error',
        //        button: {
        //            text: "OK",
        //            value: true,
        //            visible: true,
        //            className: "btn btn-primary",
        //            timer: 1000,
        //        }
        //    }).then(function () {
        //        //location.reload();
        //    }
        //                       )
        //}
        if (Datas != '' && Datas != null && Datas != []  ) {

            $('#IncentiveVerification').DataTable().clear().destroy();

            var length = Datas.length;

            var table = document.getElementById('IncentiveVerification');

            if(Datas[0].resultMsg == "current data"){
                swal({
                    title: 'Error!',
                    text: 'Current month data is yet to be generated.',
                    icon: 'error',
                    button: {
                        text: "OK",
                        value: true,
                        visible: true,
                        className: "btn btn-primary",
                        timer: 1000,
                    }
                }).then(function () {
                    //location.reload();
                }
                                           )
            }
            else if(Datas[0].resultMsg == undefined){

                $("#hiddenTable_incentive_verification").removeClass('hidden');

                $("#btnSelectedRows").removeClass('hidden');

                for (var i = 0; i < length; i++) {

                    if(Datas[i].count == undefined){
                        Datas[i].count = 0
                    }
                    if(Datas[i].incentive == undefined){
                        Datas[i].incentive = 0
                    }

                    $('#IncentiveVerification').append(
                        '<tr id="' + i + '">' +
                            '<td></td>' +
                            //'<td><input type="checkbox" id='+Datas[i].emp_id+' /></td>' +
                            '<td class="hidden">' + Datas[i].emp_id + '</td>' +
                            '<td>' + Datas[i].emp_name + '</td>' +
                            '<td>' + Datas[i].orderCount + '</td>' +
                            '<td>' + Datas[i].count + '</td>' +
                            '<td>' + Datas[i].incentive + '</td>' +
                       '</tr>');

                }




                //setTimeout(function () {
                tables =  $('#IncentiveVerification').DataTable({
                    "bpaging": false,
                    "bDestroy": true,
                    "scrollX": true,
                    select: {
                        style: 'multi',
                        info: false
                    },
                    columnDefs: [ {
                        orderable: false,
                        className: 'select-checkbox',
                        targets:   [0]
                    } ],
                })
            }


        }
        if(Datas == 0){
            $("#hiddenTable_incentive_verification").removeClass('hidden');

            $("#btnSelectedRows").removeClass('hidden');

            for (var i = 0; i < length; i++) {

                if(Datas[i].count == undefined){
                    Datas[i].count = 0
                }
                if(Datas[i].incentive == undefined){
                    Datas[i].incentive = 0
                }

                $('#IncentiveVerification').append(
                    '<tr id="' + i + '">' +
                        '<td></td>' +
                        //'<td><input type="checkbox" id='+Datas[i].emp_id+' /></td>' +
                        '<td class="hidden">' + Datas[i].emp_id + '</td>' +
                        '<td>' + Datas[i].emp_name + '</td>' +
                        '<td>' + Datas[i].orderCount + '</td>' +
                        '<td>' + Datas[i].count + '</td>' +
                        '<td>' + Datas[i].incentive + '</td>' +
                   '</tr>');

            }




            //setTimeout(function () {
            tables =  $('#IncentiveVerification').DataTable({
                "bpaging": false,
                "bDestroy": true,
                "scrollX": true,
                select: {
                    style: 'multi',
                    info: false
                },
                columnDefs: [ {
                    orderable: false,
                    className: 'select-checkbox',
                    targets:   [0]
                } ],
            })
        }


        loadergif(0);

        //$(".dt-button").addClass("btn btn-outline-primary btn-fw")
        //$(".dt-button").removeClass("dt-button")
    }

    var tblLength=0;
    var tblData=null;
    var tmpData=null;


    $('#btnSelectedRows').on('click', function() {
        tblData = tables.rows('.selected').data();
        tblLength = tables.rows( { selected: true } ).count();
        if(tblLength<=0){
            swal({
                title: 'Error',
                text: 'Please choose the data',
                icon: 'error',
                button: {
                    text: "Continue",
                    value: true,
                    visible: true,
                    className: "btn btn-primary",
                    timer: 1000,
                }
            })
            //                .then(
            //function(){
            //    location.reload();
            //}
            //)
        }else{
            incentiveApproval();
        }
        //var month = $('#month').val();
        //var year = $('#year').val();
        //alert(year);



        //for(i=0;i<tblLength;i++){
        //    tmpData = tblData[i];
        //    var emp_id = tmpData[1];
        //    var emp_name = tmpData[2];
        //    var order_count = tmpData[3];
        //    var incentive_count = tmpData[4];
        //    //console.log(tmpData);
        //    console.log(emp_id,"+",emp_name,"+",order_count,"+",incentive_count);
        //}
        //console.log(tmpData)
        //$.each(tblData, function(i, val) {
        //    tmpData = tblData[i];
        //    alert(tmpData);
        //alert (a);
        //});
    })
    //console.log(tmpData)

    function incentiveApproval(){
        for(i=0;i<tblLength;i++){
            tmpData = tblData[i];
            var empId = tmpData[1];
            var totalOrder = tmpData[3];
            var incentiveorder = tmpData[4];
            var incentiveAmount = tmpData[5];
            var month = $('#month').val();
            var year = $('#year').val();
            var strJsonDatas = eval({ empId: empId,totalOrder: totalOrder,incentiveorder: incentiveorder,incentiveAmount: incentiveAmount,month: month,year: year });
            $.ajax({
                type: "POST",
                async: false,
                url: "incentiveApproval",
                data: JSON.stringify(strJsonDatas),
                contentType: "application/json; charset=utf-8",
                success: function (msg) {
                    var data = msg;
                    if(data=="success")
                    {
                        swal({
                            title: 'Updated!',
                            text: 'The choosen details have been approved',
                            icon: 'success',
                            button: {
                                text: "Continue",
                                value: true,
                                visible: true,
                                className: "btn btn-primary",
                                timer: 1000,
                            }
                        }).then(
                        function(){
                            location.reload();
                        }
                        )
                    }
                }
            })
        }
    }

    function refreshPage(){
        location.reload();
    }


</script>

